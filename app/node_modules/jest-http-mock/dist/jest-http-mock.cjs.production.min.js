"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("http");function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function n(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return r(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}var o=function(){var e=this;this.settled=!1,this.resolve=function(t){e._resolve&&(e.settled=!0,e._resolve(t))},this.reject=function(t){e._reject&&(e.settled=!0,e._reject(t))},this.promise=new Promise((function(t,r){e._resolve=t,e._reject=r}))},i=function(){function t(e){this._options=e,this._requestHandlers=[],this._activeResponses=[],this._running=!1,this._connections=[]}var r,i=t.prototype;return i.clear=function(){this._requestHandlers=[],this._activeResponses=[];for(var e,t=n(this._connections);!(e=t()).done;){var r=e.value;r.unref(),r.destroy()}this._connections=[]},i.start=function(){var t,r,i=this;return this._running?null!=(t=null==(r=this._promiseStart)?void 0:r.promise)?t:Promise.reject("Unexpected state"):(this._running=!0,this._promiseStart=new o,this._server=e.createServer((function(e,t){var r,o,s=new URL(null!=(r=e.url)?r:"",i.host),u=i._requestHandlers.filter((function(e){return e.path===s.pathname}));t.setHeader("access-control-allow-origin",null!=(o=e.headers.origin)?o:"*");for(var a,c=n(u);!(a=c()).done;)a.value.handler(e,t);i._activeResponses.push(t)})),this._server.listen(this._options.port,(function(){var e;null==(e=i._promiseStart)||e.resolve(i)})),this._server.on("connection",(function(e){i._connections.push(e),e.on("close",(function(){i._connections=i._connections.filter((function(t){return t!==e}))}))})),this._promiseStart.promise)},i.stop=function(){var e=this;return this._running=!1,new Promise((function(t,r){var n,o;e.clear(),null==(n=e._server)||n.unref(),null==(o=e._server)||o.close((function(n){e._server=void 0,n?r(n):t()}))}))},i.waitForRequest=function(e){var t=this,r=new o,n=function e(n,o,i){if(t._removeRequestHandler(e),t._activeResponses=t._activeResponses.filter((function(e){return e!==o})),i)r.reject(i);else{var s=function(e){var t;return function(){return t||(t=new Promise((function(t,r){var n=[],o=!1;e.on("data",(function(e){n.push(e)})),e.on("error",(function(e){o=!0,r(e)})),e.on("end",(function(){o||t(Buffer.concat(n))}))}))),t}}(n);r.resolve({request:n,response:o,body:function(e){return s().then((function(t){return void 0===e?t:t.toString(e)}))}})}},i={path:e,handler:n,resolvable:r};this._requestHandlers.push(i);var s=setTimeout((function(){t._removeRequestHandler(n),r.reject(new Error("Timed out"))}),this._options.timeout);return i.promise=r.promise.then((function(e){return[null,e]})).catch((function(e){return[e,null]})).then((function(e){var t=e[0],r=e[1];return clearTimeout(s),t?Promise.reject(t):Promise.resolve(r)})),i.promise},i.stopWaiting=function(e){this._requestHandlers=this._requestHandlers.filter((function(t){return t.promise!==e||(t.resolvable.reject(new Error("Cancelled")),!1)}))},i._removeRequestHandler=function(e){this._requestHandlers=this._requestHandlers.filter((function(t){return t.handler!==e}))},(r=[{key:"port",get:function(){return this._options.port}},{key:"host",get:function(){return"http://localhost:"+this.port}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,r),t}();exports.useMockHttpServer=function(e){void 0===e&&(e={});var r=function(e){var r,n;return void 0===e&&(e={}),new i(t({},e,{port:null!=(r=e.port)?r:Math.floor(4e3+4e3*Math.random()),timeout:null!=(n=e.timeout)?n:1e3}))}(e);return beforeEach((function(){return r.clear(),r.start()})),afterEach((function(){return r.stop()})),r};
//# sourceMappingURL=jest-http-mock.cjs.production.min.js.map
